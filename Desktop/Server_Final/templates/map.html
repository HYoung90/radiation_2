<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©ì‚¬ì„  ë¹„ìƒ ëŒ€ì‘ ì˜ì‚¬ê²°ì • ì§€ì› ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        body {
            background-color: #f3f4f6; /* ë¶€ë“œëŸ¬ìš´ ë°°ê²½ìƒ‰ */
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: row;
            min-height: 100vh;
            padding-right: 20px; /* ìš°ì¸¡ ì—¬ë°± 20px ì¶”ê°€ */
            margin-left: 250px;  /* ì‚¬ì´ë“œë°” ê¸¸ì´ë§Œí¼ ì™¼ìª½ ì—¬ë°± ì¶”ê°€ (ì‚¬ì´ë“œë°” ë„“ì´ 250px) */
        }

        #map {
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* ì§€ë„ì— ê·¸ë¦¼ì ì¶”ê°€ */
            margin-bottom: 40px; /* ì§€ë„ì™€ ë²„íŠ¼ ì‚¬ì´ ê°„ê²© ì¶”ê°€ */
            flex-grow: 1;
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            width: 250px;  /* ì‚¬ì´ë“œë°” ë„“ì´ */
            background-color: #343a40;
            padding-top: 20px;
            color: white;
            font-size: 18px;
            text-align: center;
            position: fixed;
            height: 100%;
            top: 0;
            left: 0;
            box-shadow: 4px 0 8px rgba(0, 0, 0, 0.1); /* ì˜¤ë¥¸ìª½ ê²½ê³„ì— ê·¸ë¦¼ì ì¶”ê°€ */
        }

        .sidebar img {
            width: 200px; /* ì‚¬ì´ë“œë°” ì´ë¯¸ì§€ í¬ê¸° ì¦ê°€ */
            margin-bottom: 30px; /* ì´ë¯¸ì§€ì™€ ë©”ë‰´ í•­ëª© ê°„ ê°„ê²© */
            cursor: pointer;
        }

        .sidebar a {
            color: white;
            padding: 15px;
            text-decoration: none;
            display: block;
            transition: 0.3s;
            white-space: normal; /* í…ìŠ¤íŠ¸ê°€ ê¸¸ë©´ ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆ */
            word-wrap: break-word; /* ê¸´ ë‹¨ì–´ê°€ ë„˜ì¹˜ì§€ ì•Šë„ë¡ ì„¤ì • */
            overflow-wrap: break-word; /* í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê¸¸ì–´ì„œ ë„˜ì¹  ê²½ìš° ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆ */
        }

        .sidebar a:hover {
            background-color: #575757;
            transform: translateX(5px);
        }

        .container {
            margin-top: 20px;
            flex-grow: 1;
            padding-left: 20px; /* ì¢Œì¸¡ ì—¬ë°± 20px ì¶”ê°€ */
            margin-right: 20px;  /* ìš°ì¸¡ ì—¬ë°± 20px ì¶”ê°€ */
        }

        .header-container {
            display: flex;
            flex-direction: column;      /* â† ì¤‘ì•™ ì„¸ë¡œì •ë ¬ë¡œ ë³€ê²½ */
            align-items: center;         /* â† ì¤‘ì•™ ì„¸ë¡œì •ë ¬ë¡œ ë³€ê²½ */
            justify-content: center;     /* â† ì¤‘ì•™ì •ë ¬ë¡œ ë³€ê²½ */
            margin-bottom: 20px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #f5f5f5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .header-logo img {
            height: 180px; /* ë¡œê³  í¬ê¸° í™•ëŒ€ */
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .header-logo img:hover {
            transform: scale(1.05); /* ë¡œê³ ì— hover ì‹œ í™•ëŒ€ íš¨ê³¼ */
        }

        .title-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .title-container h1 {
            font-size: 36px;
            margin: 0;
            color: #000000;
            text-align: center;  /* â† ì´ ë¶€ë¶„ë„ í˜¹ì‹œ ëª¨ë¥´ë‹ˆ ì¶”ê°€ */
            width: 100%;
        }

        .refresh-icon {
            font-size: 15px;   /* â† 18pxì—ì„œ 15pxë¡œ ì¤„ì´ê¸° (2~3pt ê°ì†Œ) */
            color: #333;
            font-weight: bold;
            margin-top: 10px;   /* ì œëª©ê³¼ ì‹œê³„ ì‚¬ì´ ì‚´ì§ ê°„ê²© */
            width: 100%;
            display: flex;
            justify-content: flex-end;  /* ì‹œê³„ë¥¼ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ */
        }

        /* ê¸°ìƒ ë°ì´í„° ê·¸ë¦¬ë“œ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));  /* ê·¸ë¦¬ë“œë¥¼ ë°˜ì‘í˜•ìœ¼ë¡œ ì„¤ì • */
            gap: 15px;
            margin-top: 20px;
        }

        .grid-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            text-align: left;
            font-family: Arial, sans-serif;
        }

        .grid-item h5 {
            margin-bottom: 10px;
            font-size: 18px;
            color: #333;
        }

        .grid-item p {
            font-size: 14px;
            color: #555;
            margin: 5px 0;
        }

        .grid-item p strong {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <!-- ì´ë¯¸ì§€ë¡œ ë°©ì‚¬ì„  ë°ì´í„° ì œëª© ëŒ€ì²´ -->
        <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="ë°©ì‚¬ì„  ë°ì´í„°" onclick="location.reload()">
        <a href="/radiation_summary">ì£¼ê°„ ë°©ì‚¬ì„ ëŸ‰ ë°ì´í„°</a> <!-- ìˆœì„œ ë³€ê²½: ì£¼ê°„ ë°©ì‚¬ì„ ëŸ‰ ë°ì´í„° -->
        <a href="/nuclear_radiation">ì›ìë ¥ ë°œì „ì†Œ ì£¼ë³€ ë°©ì‚¬ì„ ëŸ‰ ë°ì´í„°</a> <!-- ìˆœì„œ ë³€ê²½ -->
        <a href="/busan_radiation">ë¶€ì‚° í™˜ê²½ë°©ì‚¬ì„ ëŸ‰ ë°ì´í„°</a> <!-- ìˆœì„œ ë³€ê²½ -->
        <a href="{{ url_for('accident_select') }}">ì›ìë ¥ ë°œì „ì†Œ ì‚¬ê³  íŒë‹¨</a>
        <a href="{{ url_for('optimal_shelter_evaluation') }}">êµ¬í˜¸ì†Œ ëŒ€í”¼ ì í•©ë„ í‰ê°€</a>
        <a href="/spectrum">ë°©ì‚¬ì„± í•µì¢… ìŠ¤í™íŠ¸ëŸ¼ ë¶„ì„</a> <!-- ìˆœì„œ ë³€ê²½ -->
        <a href="/analysis1">í† ì–‘ ë°©ì‚¬ëŠ¥ ë°ì´í„°</a> <!-- ìˆœì„œ ë³€ê²½ -->
        <a href="/analysis2">ëŒ€ê¸° ì¤‘ ë°©ì‚¬ëŠ¥ ë°ì´í„°</a> <!-- ìˆœì„œ ë³€ê²½ -->
        <a href="/analysis4">ìˆ˜ì¤‘ ë°©ì‚¬ëŠ¥ ë°ì´í„°</a> <!-- ìˆœì„œ ë³€ê²½ -->
    </div>

    <!-- ì»¨í…ì¸  ì˜ì—­ -->
    <div class="container mt-5">
        <div class="header-container">
            <div class="title-container">
                <h1 id="title">ë°©ì‚¬ì„  ë¹„ìƒ ëŒ€ì‘ ì˜ì‚¬ê²°ì • ì§€ì› ì‹œìŠ¤í…œ </h1>
            </div>
            <div class="refresh-icon">
                <span id="currentTime"></span>
            </div>
        </div>

        <div id="map"></div>

        <!-- ê¸°ìƒ ìµœì‹  ë°ì´í„° í‘œì‹œ ê³µê°„ -->
        <div class="weather-container">
            <h2 class="mb-4">ìµœê·¼ ê¸°ìƒ ë°ì´í„°</h2>
            <div class="grid-container" id="weatherGridContainer">
                <!-- ê¸°ìƒ ë°ì´í„°ë¥¼ ê·¸ë¦¬ë“œ í˜•ì‹ìœ¼ë¡œ ì¶”ê°€í•  ê³µê°„ -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        function updateCurrentTime() {
            var now = new Date();
            var formattedDateTime = now.toLocaleString(); // Includes date and time
            document.getElementById('currentTime').textContent = formattedDateTime;
        }

        updateCurrentTime();
        setInterval(updateCurrentTime, 1000); // Update every second

        var map = L.map('map').setView([36.5, 127.5], 7);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a> | &copy; OpenStreetMap contributors',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        var regions = {
            "KR": [35.3213, 129.2941, "ê³ ë¦¬ ì›ìë ¥ë°œì „ì†Œ"],
            "WS": [35.7131, 129.4775, "ì›”ì„± ì›ìë ¥ë°œì „ì†Œ"],
            "YK": [35.4165, 126.4178, "í•œë¹› ì›ìë ¥ë°œì „ì†Œ"],
            "UJ": [37.0941, 129.3819, "í•œìš¸ ì›ìë ¥ë°œì „ì†Œ"],
            "SU": [35.3376, 129.3115, "ìƒˆìš¸ ì›ìë ¥ë°œì „ì†Œ"],
        };

        for (var genName in regions) {
            var marker = L.marker([regions[genName][0], regions[genName][1]]).addTo(map)
                .bindPopup('<div class="custom-popup-title"><a href="/' + genName + '" style="text-decoration:none;color:black;">' + regions[genName][2] + '</a></div>');

            marker.on('click', function() {
                this.openPopup();
            });
        }

        function loadLatestWeatherData() {
            const weatherGridContainer = document.getElementById("weatherGridContainer");
            weatherGridContainer.innerHTML = "";  // ê¸°ì¡´ ë‚´ìš©ì„ ì§€ìš°ê¸°
            const plantNames = {
                "KR": "ê³ ë¦¬ ì›ìë ¥ë°œì „ì†Œ",
                "WS": "ì›”ì„± ì›ìë ¥ë°œì „ì†Œ",
                "YK": "í•œë¹› ì›ìë ¥ë°œì „ì†Œ",
                "UJ": "í•œìš¸ ì›ìë ¥ë°œì „ì†Œ",
                "SU": "ìƒˆìš¸ ì›ìë ¥ë°œì „ì†Œ"
            };

            for (let genName in plantNames) {
                fetch(`/api/data/${genName}/latest`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Received latest data for genName ${genName}:`, data);
                        if (data.time) {
                            const gridItem = document.createElement("div");
                            gridItem.className = "grid-item";
                            gridItem.innerHTML = `
                                <h5>${plantNames[genName]}</h5>
                                <p><strong>Time:</strong> ${data.time || 'N/A'}</p>
                                <p><strong>Temperature:</strong> ${data.temperature || 'N/A'}Â°C</p>
                                <p><strong>Humidity:</strong> ${data.humidity || 'N/A'}%</p>
                                <p><strong>Rainfall:</strong> ${data.rainfall || '0 '}mm</p>
                                <p><strong>Windspeed:</strong> ${data.windspeed || '0 '}m/s</p>
                                <p><strong>Winddirection:</strong> ${data.winddirection || 'N/A'}Â°</p>
                                <p><strong>Stability:</strong> ${data.stability || 'N/A'}</p>
                            `;
                            weatherGridContainer.appendChild(gridItem);
                        } else {
                            console.error(`Unexpected data format for genName ${genName}:`, data);
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching latest weather data for genName ${genName}:`, error);
                    });
            }
        }

        loadLatestWeatherData();
    </script>

    <!-- ğŸ‘‡ ì´ ë¶€ë¶„ë¶€í„° ì•„ë˜ë¡œ ì¶”ê°€í•˜ì„¸ìš” (</body> ë°”ë¡œ ìœ„ì— ì‚½ì…) -->

    <!-- ì±—ë´‡ ì•„ì´ì½˜ -->
    <div id="chat-icon" style="position: fixed; bottom: 24px; right: 24px; z-index: 1000; cursor: pointer;">
      <img src="{{ url_for('static', filename='images/chat_icon.png') }}" alt="Chat" width="60" height="60">
    </div>

    <!-- ì±—ë´‡ ì°½ -->
    <div id="chat-box" style="display:none; position:fixed; bottom:100px; right:24px; width:300px; height:400px; background:white; border:1px solid #ccc; border-radius:10px; z-index:1000; box-shadow:0 4px 12px rgba(0,0,0,0.15); overflow:hidden; font-family: sans-serif;">
      <header style="background:#007bff; color:white; padding:10px; font-weight:bold;">ë¹„ìƒ ëŒ€ì‘ ì±—ë´‡</header>
      <div id="chat-messages" style="padding:10px; height:300px; overflow-y:auto; font-size:14px;"></div>
      <div style="display:flex; border-top:1px solid #ccc;">
        <input id="user-input" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex:1; padding:8px; border:none;">
        <button onclick="sendMessage()" style="background:#007bff; color:white; border:none; padding:8px 12px;">ì „ì†¡</button>
      </div>
    </div>

    <script>
      const chatIcon = document.getElementById("chat-icon");
      const chatBox = document.getElementById("chat-box");
      const chatMessages = document.getElementById("chat-messages");

      chatIcon.onclick = () => {
        chatBox.style.display = (chatBox.style.display === "none") ? "block" : "none";
      };

      function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value.trim();
        if (!message) return;

        chatMessages.innerHTML += `<div><strong>ğŸ‘¤ ì‚¬ìš©ì:</strong> ${message}</div>`;
        input.value = "";

        fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        })
        .then(res => res.json())
        .then(data => {
          const answer = data.answer || "ë‹µë³€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          chatMessages.innerHTML += `<div><strong>ğŸ¤– ì±—ë´‡:</strong> ${answer}</div>`;
          chatMessages.scrollTop = chatMessages.scrollHeight;
        })
        .catch(() => {
          chatMessages.innerHTML += `<div><strong>ğŸ¤– ì±—ë´‡:</strong> ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
        });
      }
    </script>
</body>
</html>
